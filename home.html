<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
  />
  <title>School Library Management</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #2d3748;
      overflow-x: hidden;
    }

    .background-bubbles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .bubble {
      position: absolute;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      animation: float 6s ease-in-out infinite;
    }

    .bubble:nth-child(1) { width: 80px; height: 80px; left: 10%; animation-delay: 0s; }
    .bubble:nth-child(2) { width: 60px; height: 60px; left: 20%; animation-delay: 2s; }
    .bubble:nth-child(3) { width: 100px; height: 100px; left: 35%; animation-delay: 4s; }
    .bubble:nth-child(4) { width: 120px; height: 120px; left: 50%; animation-delay: 0s; }
    .bubble:nth-child(5) { width: 70px; height: 70px; left: 70%; animation-delay: 3s; }
    .bubble:nth-child(6) { width: 90px; height: 90px; left: 80%; animation-delay: 1s; }

    @keyframes float {
      0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
      10%, 90% { opacity: 1; }
      50% { transform: translateY(-100px) rotate(180deg); }
    }

    header { 
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      color: #4c51bf;
      padding: 2rem;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 10;
    }

    header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    nav { 
      display: flex; 
      justify-content: center; 
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      padding: 1rem;
      gap: 1rem;
      flex-wrap: wrap;
      position: relative;
      z-index: 10;
    }

    nav button { 
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      border: none; 
      color: white; 
      padding: 12px 24px; 
      cursor: pointer;
      border-radius: 25px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
      position: relative;
      overflow: hidden;
    }

    nav button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    nav button:hover::before {
      left: 100%;
    }

    nav button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
    }

    nav button.active { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      transform: translateY(-1px);
    }

    main {
      position: relative;
      z-index: 5;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    section { 
      display: none; 
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: slideIn 0.5s ease-out;
    }

    section.active { 
      display: block; 
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      padding: 1.5rem;
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(252, 182, 159, 0.3);
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 800;
      color: #2d3748;
      display: block;
    }

    .stat-label {
      font-weight: 600;
      color: #4a5568;
      margin-top: 0.5rem;
    }

    .form-group { 
      margin-bottom: 1.5rem; 
    }

    .form-group label { 
      display: block; 
      margin-bottom: 0.5rem; 
      font-weight: 600;
      color: #4a5568;
    }

    .form-group input, select, textarea { 
      width: 100%; 
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.8);
    }

    .form-group input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    .btn {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
    }

    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 1.5rem; 
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    th, td { 
      padding: 1rem; 
      text-align: left; 
      border-bottom: 1px solid rgba(226, 232, 240, 0.8);
    }

    th { 
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      font-weight: 700;
      color: #2d3748;
    }

    tr:hover {
      background: rgba(102, 126, 234, 0.05);
    }

    .mode-switch { 
      display: flex; 
      margin-bottom: 2rem;
      background: rgba(226, 232, 240, 0.5);
      border-radius: 16px;
      padding: 4px;
    }

    .mode-btn { 
      flex: 1; 
      text-align: center; 
      padding: 12px;
      cursor: pointer;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      color: #4a5568;
    }

    .mode-btn.active { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .notification { 
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      z-index: 1000;
      animation: slideInRight 0.3s ease;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .success { 
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      color: #1a202c;
    }

    .error { 
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: #742a2a;
    }

    .danger { 
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
      color: #742a2a;
      border: none; 
      padding: 8px 12px; 
      cursor: pointer; 
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .danger:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(255, 154, 158, 0.4);
    }

    .search-container {
      position: relative;
      margin-bottom: 1.5rem;
    }

    .search-container::before {
      content: 'üîç';
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1;
    }

    .search-container input {
      padding-left: 40px;
    }

    .return-section {
      background: rgba(255, 255, 255, 0.6);
      border-radius: 16px;
      padding: 1.5rem;
      margin-top: 1.5rem;
    }

    .return-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.8);
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
    }

    .return-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .search-dropdown {
      position: relative;
    }

    .search-dropdown input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.8);
    }

    .search-dropdown input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #e2e8f0;
      border-top: none;
      border-radius: 0 0 12px 12px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .dropdown-list.active {
      display: block;
    }

    .dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid #f1f5f9;
    }

    .dropdown-item:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item.selected {
      background: rgba(102, 126, 234, 0.1);
      font-weight: 600;
    }
    nav {
      flex-direction: row;
      align-items: center;
    }
      
    nav button {
      width: 100%;
      max-width: 300px;
    }
      
    .dashboard-stats {
       grid-template-columns: 1fr;
     }
      
     .mode-switch {
      flex-direction: column;
    }

    .animate__animated.animate__backInDown {
  --animate-duration: 0.7s;
}
    
  </style>
</head>
<body>
  <div class="background-bubbles">
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
  </div>

  <header>
    <h1 class="animate__animated animate__backInDown">üìö School Library Management</h1>
    <p>Modern ‚Ä¢ Intuitive ‚Ä¢ Efficient</p>
  </header>

  <nav>
    <button class="nav-tab" onclick="showTab('dashboard', event)">üìä Dashboard</button>
    <button class="nav-tab" onclick="showTab('books', event)">üìñ Books</button>
    <button class="nav-tab" onclick="showTab('students', event)">üë©‚Äçüéì Students</button>
    <button class="nav-tab" onclick="showTab('borrow', event)">üîÑ Borrow/Return</button>
    <button onclick="exportData()">üì§ Export Data</button>
    <button onclick="showImportModal()">üì• Import Data</button>
  </nav>

  <main>
    <section id="dashboard" class="active">
      <h2>üìä Dashboard Overview</h2>
      <div class="dashboard-stats">
        <div class="stat-card">
          <span class="stat-number" id="totalBooks">0</span>
          <div class="stat-label">Total Books</div>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="totalStudents">0</span>
          <div class="stat-label">Total Students</div>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="totalBorrowed">0</span>
          <div class="stat-label">Currently Borrowed</div>
        </div>
      </div>
    </section>

    <section id="books">
      <h2>üìñ Book Management</h2>
      <div class="mode-switch">
        <div class="mode-btn active" onclick="switchBookMode('single', event)">üìñ Add Single Book</div>
        <div class="mode-btn" onclick="switchBookMode('bulk', event)">üìö Add Multiple Books</div>
      </div>
      
      <div id="singleBookForm">
        <div class="form-group">
          <label>üìö Book Title</label>
          <input type="text" id="bookTitle" placeholder="Enter book title...">
        </div>
        <div class="form-group">
          <label>‚úçÔ∏è Author</label>
          <input type="text" id="bookAuthor" placeholder="Enter author name...">
        </div>
        <div class="form-group">
          <label>üî¢ ISBN</label>
          <input type="text" id="bookISBN" placeholder="Enter ISBN...">
        </div>
        <button class="btn" onclick="addBook()">‚ú® Add Book</button>
      </div>
      
      <div id="bulkBookForm" style="display:none;">
        <div class="form-group">
          <label>üìù Bulk Import (Title,Author,ISBN per line)</label>
          <textarea id="bulkBooks" rows="6" placeholder="Harry Potter,J.K. Rowling,123456789&#10;Lord of the Rings,J.R.R. Tolkien,987654321"></textarea>
        </div>
        <button class="btn" onclick="addBulkBooks()">üìö Add All Books</button>
      </div>
      
      <div class="search-container">
        <input type="text" id="bookSearch" oninput="displayBooks()" placeholder="Search books by title, author, or ISBN...">
      </div>
      <div id="bookList"></div>
    </section>

    <section id="students">
      <h2>üë©‚Äçüéì Student Management</h2>
      <div class="form-group">
        <label>üë§ Student Name</label>
        <input type="text" id="studentName" placeholder="Enter student name...">
      </div>
      <div class="form-group">
        <label>üéì Grade Level</label>
        <input type="text" id="studentGrade" placeholder="Enter grade (e.g., 10th Grade)...">
      </div>
      <button class="btn" onclick="addStudent()">‚ûï Add Student</button>
      
      <div class="search-container">
        <input type="text" id="studentSearch" oninput="displayStudents()" placeholder="Search students by name or grade...">
      </div>
      <div id="studentList"></div>
    </section>

    <section id="borrow">
      <h2>üîÑ Borrow & Return System</h2>
      <div style="background: rgba(255,255,255,0.6); padding: 1.5rem; border-radius: 16px; margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem; color: #4a5568;">üìö Borrow a Book</h3>
        <div class="form-group">
          <label>üë§ Select Student</label>
          <div class="search-dropdown">
            <input type="text" id="borrowStudent" placeholder="Search and select a student..." autocomplete="off" 
                   onfocus="showStudentDropdown()" oninput="filterStudents()" onblur="hideStudentDropdown()">
            <div id="studentDropdown" class="dropdown-list"></div>
          </div>
        </div>
        <div class="form-group">
          <label>üìñ Select Book</label>
          <div class="search-dropdown">
            <input type="text" id="borrowBook" placeholder="Search and select a book..." autocomplete="off"
                   onfocus="showBookDropdown()" oninput="filterBooks()" onblur="hideBookDropdown()">
            <div id="bookDropdown" class="dropdown-list"></div>
          </div>
        </div>
        <button class="btn" onclick="borrowBook()">üöÄ Borrow Book</button>
      </div>
      
      <div class="return-section">
        <h3 style="margin-bottom: 1rem; color: #4a5568;">üì§ Return Books</h3>
        <div id="returnList"></div>
      </div>
    </section>
  </main>

  <div id="notification"></div>

  <!-- Import Modal -->
  <div id="importModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; backdrop-filter: blur(5px);">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 style="margin: 0; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üì• Import Library Data</h3>
        <button onclick="closeImportModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #718096;">‚úï</button>
      </div>
      
      <div class="mode-switch" style="margin-bottom: 1.5rem;">
        <div class="mode-btn active" onclick="switchImportMode('file', event)">üìÑ Import File</div>
        <div class="mode-btn" onclick="switchImportMode('paste', event)">üìã Paste Data</div>
      </div>
      
      <div id="fileImportForm">
        <div class="form-group">
          <label>üìÅ Select JSON File</label>
          <input type="file" id="importFile" accept=".json" style="padding: 0.75rem; border: 2px dashed #cbd5e0; background: #f7fafc;">
        </div>
        <div style="background: rgba(102, 126, 234, 0.1); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
          <small style="color: #4a5568;">
            üí° <strong>Supported formats:</strong><br>
            ‚Ä¢ Previously exported JSON files from this system<br>
            ‚Ä¢ Custom JSON with books, students, and borrowings arrays<br>
            ‚Ä¢ The import will merge with existing data (no duplicates)
          </small>
        </div>
        <button class="btn" onclick="importFromFile()" style="width: 100%;">üöÄ Import from File</button>
      </div>
      
      <div id="pasteImportForm" style="display: none;">
        <div class="form-group">
          <label>üìã Paste JSON Data</label>
          <textarea id="importData" rows="8" placeholder='Paste your JSON data here...&#10;Example:&#10;{&#10;  "books": [...],&#10;  "students": [...],&#10;  "borrowings": [...]&#10;}'></textarea>
        </div>
        <button class="btn" onclick="importFromText()" style="width: 100%;">üöÄ Import from Text</button>
      </div>
      
      <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255, 193, 7, 0.1); border-radius: 12px;">
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <span style="font-size: 1.2rem;">‚ö†Ô∏è</span>
          <strong style="color: #d69e2e;">Import Options</strong>
        </div>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="replaceData" style="width: auto;">
          <span>Replace all existing data (otherwise merge)</span>
        </label>
      </div>
    </div>
  </div>

  <script>
    let books = JSON.parse(localStorage.getItem("books")) || [];
    let students = JSON.parse(localStorage.getItem("students")) || [];
    let borrowings = JSON.parse(localStorage.getItem("borrowings")) || [];

    function saveData() {
      localStorage.setItem("books", JSON.stringify(books));
      localStorage.setItem("students", JSON.stringify(students));
      localStorage.setItem("borrowings", JSON.stringify(borrowings));
    }

    function showNotification(message, type = 'success') {
      const div = document.createElement("div");
      div.className = `notification ${type}`;
      div.innerText = message;
      document.getElementById("notification").appendChild(div);
      setTimeout(() => {
        div.style.animation = 'slideInRight 0.3s ease reverse';
        setTimeout(() => div.remove(), 300);
      }, 3000);
    }

    function showTab(tab, event) {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      document.querySelector(`#${tab}`).classList.add("active");
      document.querySelectorAll(".nav-tab").forEach(b => b.classList.remove("active"));
      event.target.classList.add("active");
      localStorage.setItem("activeTab", tab);
      updateDashboard();
      displayBooks();
      displayStudents();
      updateBorrowDropdowns();
    }

    window.onload = () => {
      const savedTab = localStorage.getItem("activeTab") || "dashboard";
      const btn = document.querySelector(`.nav-tab[onclick*="${savedTab}"]`);
      if (btn) btn.click();
      updateDashboard();
      displayBooks();
      displayStudents();
    };

    function switchBookMode(mode, event) {
      document.querySelectorAll(".mode-btn").forEach(btn => btn.classList.remove("active"));
      event.target.classList.add("active");
      document.getElementById("singleBookForm").style.display = mode === "single" ? "block" : "none";
      document.getElementById("bulkBookForm").style.display = mode === "bulk" ? "block" : "none";
    }

    function addBook() {
      const title = document.getElementById("bookTitle").value.trim();
      const author = document.getElementById("bookAuthor").value.trim();
      const isbn = document.getElementById("bookISBN").value.trim();
      
      if (!title || !author || !isbn) {
        return showNotification("Please fill in all fields! üìù", "error");
      }
      
      if (books.some(b => b.isbn === isbn)) {
        return showNotification("This ISBN already exists! üö´", "error");
      }
      
      books.push({ title, author, isbn, available: true });
      saveData(); 
      displayBooks(); 
      updateDashboard();
      
      // Clear form
      document.getElementById("bookTitle").value = "";
      document.getElementById("bookAuthor").value = "";
      document.getElementById("bookISBN").value = "";
      
      showNotification(`"${title}" has been added successfully! üéâ`);
    }

    function addBulkBooks() {
      const lines = document.getElementById("bulkBooks").value.trim().split("\n").filter(line => line.trim());
      let added = 0;
      let errors = 0;
      
      lines.forEach(line => {
        const parts = line.split(",").map(part => part.trim());
        if (parts.length >= 3) {
          const [title, author, isbn] = parts;
          if (title && author && isbn && !books.some(b => b.isbn === isbn)) {
            books.push({ title, author, isbn, available: true });
            added++;
          } else {
            errors++;
          }
        } else {
          errors++;
        }
      });
      
      saveData(); 
      displayBooks(); 
      updateDashboard();
      document.getElementById("bulkBooks").value = "";
      
      if (added > 0) {
        showNotification(`${added} books added successfully! üéâ`);
      }
      if (errors > 0) {
        showNotification(`${errors} entries had errors and were skipped ‚ö†Ô∏è`, "error");
      }
    }

    function displayBooks() {
      const search = document.getElementById("bookSearch").value.toLowerCase();
      const list = document.getElementById("bookList");
      const filtered = books.filter(b => 
        b.title.toLowerCase().includes(search) || 
        b.author.toLowerCase().includes(search) || 
        b.isbn.toLowerCase().includes(search)
      );
      
      if (filtered.length === 0) {
        list.innerHTML = "<div style='text-align: center; padding: 2rem; color: #718096;'>üìö No books found matching your search.</div>";
        return;
      }
      
      list.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>üìö Title</th>
              <th>‚úçÔ∏è Author</th>
              <th>üî¢ ISBN</th>
              <th>üìä Status</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(b => `
              <tr>
                <td><strong>${b.title}</strong></td>
                <td>${b.author}</td>
                <td><code>${b.isbn}</code></td>
                <td>
                  <span style="padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; ${b.available ? 'background: linear-gradient(135deg, #84fab0, #8fd3f4); color: #1a202c;' : 'background: linear-gradient(135deg, #ffecd2, #fcb69f); color: #742a2a;'}">
                    ${b.available ? '‚úÖ Available' : 'üì§ Borrowed'}
                  </span>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function addStudent() {
      const name = document.getElementById("studentName").value.trim();
      const grade = document.getElementById("studentGrade").value.trim();
      
      if (!name || !grade) {
        return showNotification("Please fill in all fields! üìù", "error");
      }
      
      // Check for duplicate names in the same grade
      if (students.some(s => s.name.toLowerCase() === name.toLowerCase() && s.grade.toLowerCase() === grade.toLowerCase())) {
        return showNotification("A student with this name already exists in this grade! üö´", "error");
      }
      
      const id = Date.now();
      students.push({ id, name, grade, borrowedBooks: [] });
      saveData(); 
      displayStudents(); 
      updateDashboard();
      
      // Clear form
      document.getElementById("studentName").value = "";
      document.getElementById("studentGrade").value = "";
      
      showNotification(`${name} has been registered successfully! üéâ`);
    }

    function deleteStudent(id) {
      const student = students.find(st => st.id === id);
      if (student && student.borrowedBooks.length > 0) {
        return showNotification(`${student.name} has borrowed books and cannot be deleted! üìö`, "error");
      }
      
      students = students.filter(st => st.id !== id);
      saveData(); 
      displayStudents(); 
      updateDashboard();
      showNotification("Student removed successfully! ‚úÖ");
    }

    function displayStudents() {
      const search = document.getElementById("studentSearch").value.toLowerCase();
      const list = document.getElementById("studentList");
      const filtered = students.filter(s => 
        s.name.toLowerCase().includes(search) || 
        s.grade.toLowerCase().includes(search)
      );
      
      if (filtered.length === 0) {
        list.innerHTML = "<div style='text-align: center; padding: 2rem; color: #718096;'>üë©‚Äçüéì No students found matching your search.</div>";
        return;
      }
      
      list.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>üë§ Name</th>
              <th>üéì Grade</th>
              <th>üìö Books Borrowed</th>
              <th>üóëÔ∏è Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(s => `
              <tr>
                <td><strong>${s.name}</strong></td>
                <td>${s.grade}</td>
                <td>
                  <span style="padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; background: linear-gradient(135deg, #a8edea, #fed6e3); color: #2d3748;">
                    ${s.borrowedBooks.length} book${s.borrowedBooks.length !== 1 ? 's' : ''}
                  </span>
                </td>
                <td>
                  <button class="danger" onclick="deleteStudent(${s.id})" ${s.borrowedBooks.length > 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                    üóëÔ∏è Remove
                  </button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function updateBorrowDropdowns() {
      // This function now just updates the return list since we're using search inputs
      displayReturnList();
    }

    let selectedStudent = null;
    let selectedBook = null;
    let studentDropdownTimeout = null;
    let bookDropdownTimeout = null;

    function showStudentDropdown() {
      clearTimeout(studentDropdownTimeout);
      const dropdown = document.getElementById('studentDropdown');
      dropdown.classList.add('active');
      filterStudents();
    }

    function hideStudentDropdown() {
      studentDropdownTimeout = setTimeout(() => {
        document.getElementById('studentDropdown').classList.remove('active');
      }, 200);
    }

    function showBookDropdown() {
      clearTimeout(bookDropdownTimeout);
      const dropdown = document.getElementById('bookDropdown');
      dropdown.classList.add('active');
      filterBooks();
    }

    function hideBookDropdown() {
      bookDropdownTimeout = setTimeout(() => {
        document.getElementById('bookDropdown').classList.remove('active');
      }, 200);
    }

    function filterStudents() {
      const input = document.getElementById('borrowStudent');
      const dropdown = document.getElementById('studentDropdown');
      const searchTerm = input.value.toLowerCase();
      
      const filteredStudents = students.filter(student => 
        student.name.toLowerCase().includes(searchTerm) ||
        student.grade.toLowerCase().includes(searchTerm)
      );
      
      if (filteredStudents.length === 0) {
        dropdown.innerHTML = '<div class="dropdown-item" style="color: #718096; cursor: default;">No students found</div>';
        selectedStudent = null;
        return;
      }
      
      dropdown.innerHTML = filteredStudents.map(student => `
        <div class="dropdown-item" onmousedown="selectStudent(${student.id}, '${student.name.replace(/'/g, "\\'")} (${student.grade})')">
          <strong>${student.name}</strong><br>
          <small style="color: #718096;">${student.grade} ‚Ä¢ ${student.borrowedBooks.length} book${student.borrowedBooks.length !== 1 ? 's' : ''} borrowed</small>
        </div>
      `).join('');
    }

    function filterBooks() {
      const input = document.getElementById('borrowBook');
      const dropdown = document.getElementById('bookDropdown');
      const searchTerm = input.value.toLowerCase();
      
      const availableBooks = books.filter(book => 
        book.available && (
          book.title.toLowerCase().includes(searchTerm) ||
          book.author.toLowerCase().includes(searchTerm) ||
          book.isbn.toLowerCase().includes(searchTerm)
        )
      );
      
      if (availableBooks.length === 0) {
        dropdown.innerHTML = '<div class="dropdown-item" style="color: #718096; cursor: default;">No available books found</div>';
        selectedBook = null;
        return;
      }
      
      dropdown.innerHTML = availableBooks.map(book => `
        <div class="dropdown-item" onmousedown="selectBook('${book.isbn}', '${book.title.replace(/'/g, "\\'")} by ${book.author.replace(/'/g, "\\'")}')" >
          <strong>${book.title}</strong><br>
          <small style="color: #718096;">by ${book.author} ‚Ä¢ ISBN: ${book.isbn}</small>
        </div>
      `).join('');
    }

    function selectStudent(id, displayName) {
      selectedStudent = id;
      document.getElementById('borrowStudent').value = displayName;
      document.getElementById('studentDropdown').classList.remove('active');
    }

    function selectBook(isbn, displayName) {
      selectedBook = isbn;
      document.getElementById('borrowBook').value = displayName;
      document.getElementById('bookDropdown').classList.remove('active');
    }

    function borrowBook() {
      if (!selectedStudent || !selectedBook) {
        return showNotification("Please select both student and book from the search results! üìù", "error");
      }
      
      const student = students.find(s => s.id === selectedStudent);
      const book = books.find(b => b.isbn === selectedBook);
      
      if (!student || !book || !book.available) {
        return showNotification("Invalid selection or book not available! üö´", "error");
      }
      
      // Check borrowing limit (optional: limit to 3 books per student)
      if (student.borrowedBooks.length >= 3) {
        return showNotification(`${student.name} has reached the borrowing limit (3 books)! üìö`, "error");
      }
      
      student.borrowedBooks.push(book.isbn);
      book.available = false;
      borrowings.push({ 
        studentId: selectedStudent, 
        isbn: selectedBook, 
        date: new Date().toISOString(),
        studentName: student.name,
        bookTitle: book.title
      });
      
      saveData(); 
      updateDashboard();
      updateBorrowDropdowns();
      
      // Clear selections and inputs
      selectedStudent = null;
      selectedBook = null;
      document.getElementById('borrowStudent').value = '';
      document.getElementById('borrowBook').value = '';
      
      showNotification(`üìö "${book.title}" borrowed by ${student.name}! üéâ`);
    }

    function returnBook(studentId, isbn) {
      const student = students.find(s => s.id === studentId);
      const book = books.find(b => b.isbn === isbn);
      
      if (student && book) {
        student.borrowedBooks = student.borrowedBooks.filter(b => b !== isbn);
        book.available = true;
        borrowings = borrowings.filter(b => !(b.studentId === studentId && b.isbn === isbn));
        
        saveData(); 
        updateDashboard();
        updateBorrowDropdowns();
        showNotification(`üì§ "${book.title}" returned by ${student.name}! ‚úÖ`);
      }
    }

    function displayReturnList() {
      const div = document.getElementById("returnList");
      let html = "";
      
      const studentsWithBooks = students.filter(s => s.borrowedBooks.length > 0);
      
      if (studentsWithBooks.length === 0) {
        div.innerHTML = "<div style='text-align: center; padding: 2rem; color: #718096;'>üìö No books are currently borrowed.</div>";
        return;
      }
      
      studentsWithBooks.forEach(student => {
        html += `
          <div style="margin-bottom: 1.5rem; background: rgba(255,255,255,0.8); padding: 1rem; border-radius: 12px;">
            <h4 style="margin: 0 0 1rem 0; color: #4a5568; font-size: 1.1rem;">
              üë§ ${student.name} (${student.grade})
            </h4>
            <div style="display: grid; gap: 0.5rem;">
        `;
        
        student.borrowedBooks.forEach(isbn => {
          const book = books.find(b => b.isbn === isbn);
          const borrowRecord = borrowings.find(b => b.studentId === student.id && b.isbn === isbn);
          const borrowDate = borrowRecord ? new Date(borrowRecord.date).toLocaleDateString() : 'Unknown';
          
          if (book) {
            html += `
              <div class="return-item">
                <div>
                  <strong>üìñ ${book.title}</strong><br>
                  <small style="color: #718096;">by ${book.author} ‚Ä¢ Borrowed: ${borrowDate}</small>
                </div>
                <button class="btn" onclick="returnBook(${student.id}, '${isbn}')" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); padding: 8px 16px; font-size: 0.9rem;">
                  üì§ Return
                </button>
              </div>
            `;
          }
        });
        
        html += `
            </div>
          </div>
        `;
      });
      
      div.innerHTML = html;
    }

    function updateDashboard() {
      document.getElementById("totalBooks").innerText = books.length;
      document.getElementById("totalStudents").innerText = students.length;
      document.getElementById("totalBorrowed").innerText = books.filter(b => !b.available).length;
      
      // Add some animation to the numbers
      const numbers = document.querySelectorAll('.stat-number');
      numbers.forEach(num => {
        num.style.transform = 'scale(1.1)';
        setTimeout(() => {
          num.style.transform = 'scale(1)';
        }, 200);
      });
    }

    function exportData() {
      const data = { 
        books, 
        students, 
        borrowings,
        exportDate: new Date().toISOString(),
        totalBooks: books.length,
        totalStudents: students.length,
        totalBorrowed: books.filter(b => !b.available).length
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `library-data-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification("üì• Library data exported successfully! üéâ");
    }

    function showImportModal() {
      document.getElementById('importModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeImportModal() {
      document.getElementById('importModal').style.display = 'none';
      document.body.style.overflow = 'auto';
      // Clear form data
      document.getElementById('importFile').value = '';
      document.getElementById('importData').value = '';
      document.getElementById('replaceData').checked = false;
    }

    function switchImportMode(mode, event) {
      document.querySelectorAll("#importModal .mode-btn").forEach(btn => btn.classList.remove("active"));
      event.target.classList.add("active");
      document.getElementById("fileImportForm").style.display = mode === "file" ? "block" : "none";
      document.getElementById("pasteImportForm").style.display = mode === "paste" ? "block" : "none";
    }

    function importFromFile() {
      const fileInput = document.getElementById('importFile');
      const file = fileInput.files[0];
      
      if (!file) {
        return showNotification("Please select a file to import! üìÅ", "error");
      }
      
      if (!file.name.endsWith('.json')) {
        return showNotification("Please select a valid JSON file! üìÑ", "error");
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          processImportData(data);
        } catch (error) {
          showNotification("Invalid JSON file format! Please check your file. üö´", "error");
        }
      };
      reader.readAsText(file);
    }

    function importFromText() {
      const textData = document.getElementById('importData').value.trim();
      
      if (!textData) {
        return showNotification("Please paste some data to import! üìã", "error");
      }
      
      try {
        const data = JSON.parse(textData);
        processImportData(data);
      } catch (error) {
        showNotification("Invalid JSON format! Please check your data. üö´", "error");
      }
    }

    function processImportData(data) {
      const replaceData = document.getElementById('replaceData').checked;
      let importStats = {
        books: { added: 0, skipped: 0 },
        students: { added: 0, skipped: 0 },
        borrowings: { added: 0, skipped: 0 }
      };
      
      try {
        // Validate data structure
        if (!data || typeof data !== 'object') {
          throw new Error("Invalid data format");
        }
        
        // Replace or merge mode
        if (replaceData) {
          books = [];
          students = [];
          borrowings = [];
          showNotification("üóëÔ∏è Existing data cleared for replacement!", "success");
        }
        
        // Import books
        if (data.books && Array.isArray(data.books)) {
          data.books.forEach(book => {
            if (book.title && book.author && book.isbn) {
              // Check for duplicates
              if (!books.some(b => b.isbn === book.isbn)) {
                books.push({
                  title: book.title,
                  author: book.author,
                  isbn: book.isbn,
                  available: book.available !== undefined ? book.available : true
                });
                importStats.books.added++;
              } else {
                importStats.books.skipped++;
              }
            }
          });
        }
        
        // Import students
        if (data.students && Array.isArray(data.students)) {
          data.students.forEach(student => {
            if (student.name && student.grade) {
              // Check for duplicates (by name and grade combination)
              if (!students.some(s => s.name.toLowerCase() === student.name.toLowerCase() && s.grade.toLowerCase() === student.grade.toLowerCase())) {
                students.push({
                  id: student.id || Date.now() + Math.random(),
                  name: student.name,
                  grade: student.grade,
                  borrowedBooks: student.borrowedBooks || []
                });
                importStats.students.added++;
              } else {
                importStats.students.skipped++;
              }
            }
          });
        }
        
        // Import borrowings (only if both student and book exist)
        if (data.borrowings && Array.isArray(data.borrowings)) {
          data.borrowings.forEach(borrow => {
            if (borrow.studentId && borrow.isbn) {
              const studentExists = students.some(s => s.id === borrow.studentId);
              const bookExists = books.some(b => b.isbn === borrow.isbn);
              
              if (studentExists && bookExists) {
                // Check for duplicates
                if (!borrowings.some(b => b.studentId === borrow.studentId && b.isbn === borrow.isbn)) {
                  borrowings.push({
                    studentId: borrow.studentId,
                    isbn: borrow.isbn,
                    date: borrow.date || new Date().toISOString(),
                    studentName: borrow.studentName,
                    bookTitle: borrow.bookTitle
                  });
                  importStats.borrowings.added++;
                } else {
                  importStats.borrowings.skipped++;
                }
              }
            }
          });
        }
        
        // Save and update UI
        saveData();
        updateDashboard();
        displayBooks();
        displayStudents();
        updateBorrowDropdowns();
        closeImportModal();
        
        // Show success message with statistics
        const totalAdded = importStats.books.added + importStats.students.added + importStats.borrowings.added;
        const totalSkipped = importStats.books.skipped + importStats.students.skipped + importStats.borrowings.skipped;
        
        let message = `üéâ Import successful! Added: ${totalAdded} items`;
        if (totalSkipped > 0) {
          message += `, Skipped: ${totalSkipped} duplicates`;
        }
        
        showNotification(message, "success");
        
        // Show detailed breakdown
        setTimeout(() => {
          if (importStats.books.added > 0) showNotification(`üìö ${importStats.books.added} books imported`, "success");
          if (importStats.students.added > 0) showNotification(`üë©‚Äçüéì ${importStats.students.added} students imported`, "success");
          if (importStats.borrowings.added > 0) showNotification(`üîÑ ${importStats.borrowings.added} borrowing records imported`, "success");
        }, 1000);
        
      } catch (error) {
        showNotification(`Import failed: ${error.message} üö´`, "error");
      }
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      // Add some initial sample data if none exists
      if (books.length === 0 && students.length === 0) {
        // Sample books
        const sampleBooks = [
          { title: "Harry Potter and the Philosopher's Stone", author: "J.K. Rowling", isbn: "9780747532699", available: true },
          { title: "To Kill a Mockingbird", author: "Harper Lee", isbn: "9780061120084", available: true },
          { title: "1984", author: "George Orwell", isbn: "9780451524935", available: true },
          { title: "The Great Gatsby", author: "F. Scott Fitzgerald", isbn: "9780743273565", available: true },
          { title: "Pride and Prejudice", author: "Jane Austen", isbn: "9780141439518", available: true },
          { title: "The Catcher in the Rye", author: "J.D. Salinger", isbn: "9780316769488", available: true },
          { title: "The Hobbit", author: "J.R.R. Tolkien", isbn: "9780547928227", available: true },
          { title: "Fahrenheit 451", author: "Ray Bradbury", isbn: "9781451673319", available: true }
        ];
        
        // Sample students
        const sampleStudents = [
          { id: 1001, name: "Emma Johnson", grade: "10th Grade", borrowedBooks: [] },
          { id: 1002, name: "Michael Chen", grade: "11th Grade", borrowedBooks: [] },
          { id: 1003, name: "Sophia Martinez", grade: "9th Grade", borrowedBooks: [] },
          { id: 1004, name: "Liam Smith", grade: "12th Grade", borrowedBooks: [] },
          { id: 1005, name: "Olivia Brown", grade: "10th Grade", borrowedBooks: [] },
          { id: 1006, name: "Noah Davis", grade: "11th Grade", borrowedBooks: [] },
          { id: 1007, name: "Ava Wilson", grade: "9th Grade", borrowedBooks: [] },
          { id: 1008, name: "Ethan Taylor", grade: "12th Grade", borrowedBooks: [] },
          { id: 1009, name: "Isabella Anderson", grade: "10th Grade", borrowedBooks: [] },
          { id: 1010, name: "Mason Thomas", grade: "11th Grade", borrowedBooks: [] }
        ];
        
        books = sampleBooks;
        students = sampleStudents;
        borrowings = [];
        
        saveData();
        showNotification("üéâ Welcome! Sample data has been loaded to get you started!", "success");
      }
      
      updateDashboard();
      displayBooks();
      displayStudents();
      updateBorrowDropdowns();
    });

    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case '1':
            e.preventDefault();
            document.querySelector('.nav-tab[onclick*="dashboard"]').click();
            break;
          case '2':
            e.preventDefault();
            document.querySelector('.nav-tab[onclick*="books"]').click();
            break;
          case '3':
            e.preventDefault();
            document.querySelector('.nav-tab[onclick*="students"]').click();
            break;
          case '4':
            e.preventDefault();
            document.querySelector('.nav-tab[onclick*="borrow"]').click();
            break;
          case 's':
            e.preventDefault();
            exportData();
            break;
          case 'i':
            e.preventDefault();
            showImportModal();
            break;
        }
      }
      
      // Close modal with Escape key
      if (e.key === 'Escape') {
        closeImportModal();
      }
    });

    // Add smooth scrolling and enhanced interactions
    document.querySelectorAll('input, select, textarea').forEach(element => {
      element.addEventListener('focus', function() {
        this.style.transform = 'translateY(-1px)';
        this.style.boxShadow = '0 8px 25px rgba(102, 126, 234, 0.15)';
      });
      
      element.addEventListener('blur', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = 'none';
      });
    });

    // Add Enter key support for forms
    document.getElementById('bookTitle').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') addBook();
    });
    
    document.getElementById('bookAuthor').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') addBook();
    });
    
    document.getElementById('bookISBN').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') addBook();
    });
    
    document.getElementById('studentName').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') addStudent();
    });
    
    document.getElementById('studentGrade').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') addStudent();
    });

    // Add keyboard navigation for search dropdowns
    document.getElementById('borrowStudent').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && selectedStudent) {
        document.getElementById('borrowBook').focus();
      }
    });
    
    document.getElementById('borrowBook').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && selectedBook) {
        borrowBook();
      }
    });

    // Clear selections when input is manually cleared
    document.getElementById('borrowStudent').addEventListener('input', function(e) {
      if (e.target.value === '') {
        selectedStudent = null;
      }
    });
    
    document.getElementById('borrowBook').addEventListener('input', function(e) {
      if (e.target.value === '') {
        selectedBook = null;
      }
    });
  </script>
</body>
</html>
