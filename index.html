<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Library Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h1 {
            color: #4a5568;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #718096;
            font-size: 1.1rem;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #4a5568;
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #fc8181, #f56565);
        }

        .btn-danger:hover {
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4fd1c7, #38b2ac);
        }

        .btn-secondary:hover {
            box-shadow: 0 4px 15px rgba(79, 209, 199, 0.4);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .card.borrowed {
            border-color: #fbb6ce;
            background: linear-gradient(135deg, #fff5f5, #fed7e2);
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .card p {
            color: #718096;
            margin-bottom: 8px;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status.available {
            background: #c6f6d5;
            color: #22543d;
        }

        .status.borrowed {
            background: #fbb6ce;
            color: #742a2a;
        }

        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }

        .search-bar input {
            padding-left: 45px;
            background: white;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .book-mode-switch, .student-mode-switch {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .bulk-section {
            display: none;
        }

        .bulk-section.active {
            display: block;
        }

        .category-management {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .category-management h3 {
            color: #4a5568;
            margin-bottom: 15px;
        }

        .category-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .category-tag {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-tag .remove-btn {
            background: #fc8181;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .add-category-form {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .add-category-form input {
            flex: 1;
            margin: 0;
        }

        .return-search-section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .borrow-search-section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            margin-top: 10px;
        }

        .search-result-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .search-result-item:hover {
            background-color: #f7fafc;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .selected-item {
            background: #e6fffa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #38b2ac;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2rem;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(45deg, #48bb78, #38a169);
        }

        .notification.error {
            background: linear-gradient(45deg, #fc8181, #f56565);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>📚 School Library</h1>
            <p class="subtitle">Modern Library Management System</p>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="showTab('books')">Books</button>
            <button class="nav-tab" onclick="showTab('students')">Students</button>
            <button class="nav-tab" onclick="showTab('borrow')">Borrow/Return</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalBooks">0</div>
                    <div class="stat-label">Total Books</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="availableBooks">0</div>
                    <div class="stat-label">Available Books</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="borrowedBooks">0</div>
                    <div class="stat-label">Borrowed Books</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalStudents">0</div>
                    <div class="stat-label">Total Students</div>
                </div>
            </div>

            <h2>Recent Activity</h2>
            <div id="recentActivity" class="grid">
                <div class="card">
                    <h3>Welcome to the Library System! 🎉</h3>
                    <p>Start by adding books and students to get started.</p>
                </div>
            </div>
        </div>

        <div id="books" class="tab-content">
            <!-- Category Management Section -->
            <div class="category-management">
                <h3>📂 Manage Categories</h3>
                <div class="category-list" id="categoryList">
                    <!-- Categories will be displayed here -->
                </div>
                <div class="add-category-form">
                    <div class="form-group" style="margin-bottom: 0; flex: 1;">
                        <input type="text" id="newCategoryInput" placeholder="Enter new category name">
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addCategory()">Add Category</button>
                </div>
            </div>

            <!-- Book Mode Switch -->
            <div class="book-mode-switch">
                <div class="mode-btn active" onclick="switchBookMode('single')">📖 Add Single Book</div>
                <div class="mode-btn" onclick="switchBookMode('bulk')">📚 Add Books in Bulk</div>
            </div>

            <!-- Single Book Form -->
            <div id="singleBookSection">
                <h2>Add New Book</h2>
                <form id="bookForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bookTitle">Book Title</label>
                            <input type="text" id="bookTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="bookAuthor">Author</label>
                            <input type="text" id="bookAuthor" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bookISBN">ISBN</label>
                            <input type="text" id="bookISBN" required>
                        </div>
                        <div class="form-group">
                            <label for="bookCategory">Category</label>
                            <select id="bookCategory" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn">Add Book</button>
                </form>
            </div>

            <!-- Bulk Book Form -->
            <div id="bulkBookSection" class="bulk-section">
                <h2>Add Books in Bulk</h2>
                <p style="color: #718096; margin-bottom: 15px;">
                    Enter multiple books, one per line in the format: <strong>Title | Author | ISBN | Category</strong>
                </p>
                <form id="bulkBookForm">
                    <div class="form-group">
                        <label for="bulkBookData">Book Data (one book per line)</label>
                        <textarea id="bulkBookData" placeholder="Example:
The Great Gatsby | F. Scott Fitzgerald | 978-0-7432-7356-5 | Fiction
To Kill a Mockingbird | Harper Lee | 978-0-06-112008-4 | Fiction
1984 | George Orwell | 978-0-452-28423-4 | Fiction" required></textarea>
                    </div>
                    <button type="submit" class="btn">Add All Books</button>
                    <button type="button" class="btn btn-secondary" onclick="clearBulkBookData()">Clear</button>
                </form>
            </div>

            <h2>Book Collection</h2>
            <div class="search-bar">
                <span class="search-icon">🔍</span>
                <input type="text" id="bookSearch" placeholder="Search books by title, author, or ISBN...">
            </div>
            <div id="bookList" class="grid"></div>
        </div>

        <div id="students" class="tab-content">
            <!-- Student Mode Switch -->
            <div class="student-mode-switch">
                <div class="mode-btn active" onclick="switchStudentMode('single')">👤 Add Single Student</div>
                <div class="mode-btn" onclick="switchStudentMode('bulk')">👥 Add Students in Bulk</div>
            </div>

            <!-- Single Student Form -->
            <div id="singleStudentSection">
                <h2>Add New Student</h2>
                <form id="studentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="studentName">Student Name</label>
                            <input type="text" id="studentName" required>
                        </div>
                        <div class="form-group">
                            <label for="studentGrade">Grade</label>
                            <select id="studentGrade" required>
                                <option value="">Select Grade</option>
                                <option value="6">Grade 6</option>
                                <option value="7">Grade 7</option>
                                <option value="8">Grade 8</option>
                                <option value="9">Grade 9</option>
                                <option value="10">Grade 10</option>
                                <option value="11">Grade 11</option>
                                <option value="12">Grade 12</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn">Add Student</button>
                </form>
            </div>

            <!-- Bulk Student Form -->
            <div id="bulkStudentSection" class="bulk-section">
                <h2>Add Students in Bulk</h2>
                <p style="color: #718096; margin-bottom: 15px;">
                    Enter multiple students, one per line in the format: <strong>Name | Grade</strong>
                </p>
                <form id="bulkStudentForm">
                    <div class="form-group">
                        <label for="bulkStudentData">Student Data (one student per line)</label>
                        <textarea id="bulkStudentData" placeholder="Example:
John Smith | 10
Sarah Johnson | 11
Michael Brown | 9
Emma Davis | 12" required></textarea>
                    </div>
                    <button type="submit" class="btn">Add All Students</button>
                    <button type="button" class="btn btn-secondary" onclick="clearBulkStudentData()">Clear</button>
                </form>
            </div>

            <h2>Student List</h2>
            <div class="search-bar">
                <span class="search-icon">🔍</span>
                <input type="text" id="studentSearch" placeholder="Search students by name...">
            </div>
            <div id="studentList" class="grid"></div>
        </div>

        <div id="borrow" class="tab-content">
            <h2>Borrow Book</h2>
            
            <!-- Student Search -->
            <div class="borrow-search-section">
                <h3>👤 Select Student</h3>
                <div class="search-bar">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="studentSearchBorrow" placeholder="Search students by name...">
                </div>
                <div id="studentSearchResults" class="search-results" style="display: none;"></div>
                <div id="selectedStudent" class="selected-item" style="display: none;"></div>
            </div>

            <!-- Book Search -->
            <div class="borrow-search-section">
                <h3>📚 Select Book</h3>
                <div class="search-bar">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="bookSearchBorrow" placeholder="Search available books by title or author...">
                </div>
                <div id="bookSearchResults" class="search-results" style="display: none;"></div>
                <div id="selectedBook" class="selected-item" style="display: none;"></div>
            </div>

            <button id="borrowBtn" class="btn" onclick="borrowBook()" disabled>Borrow Book</button>

            <h2>Return Book</h2>
            
            <!-- Search for Book to Return -->
            <div class="return-search-section">
                <h3>🔍 Search for Book to Return</h3>
                <div class="search-bar">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="returnBookSearch" placeholder="Search borrowed books by title, author, or student name...">
                </div>
                <div id="returnSearchResults" class="grid" style="margin-top: 15px;"></div>
            </div>

            <h2>Active Borrowings</h2>
            <div id="borrowingList" class="grid"></div>
        </div>
    </div>

    <script>
        // Data storage
        let books = JSON.parse(localStorage.getItem('libraryBooks')) || [];
        let students = JSON.parse(localStorage.getItem('libraryStudents')) || [];
        let borrowings = JSON.parse(localStorage.getItem('libraryBorrowings')) || [];
        let categories = JSON.parse(localStorage.getItem('libraryCategories')) || [
            'Fiction', 'Non-Fiction', 'Science', 'History', 'Biography', 'Reference'
        ];

        // Borrow form state
        let selectedStudentForBorrow = null;
        let selectedBookForBorrow = null;

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('libraryBooks', JSON.stringify(books));
            localStorage.setItem('libraryStudents', JSON.stringify(students));
            localStorage.setItem('libraryBorrowings', JSON.stringify(borrowings));
            localStorage.setItem('libraryCategories', JSON.stringify(categories));
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'books') {
                displayBooks();
                displayCategories();
                updateCategoryDropdown();
            }
            if (tabName === 'students') displayStudents();
            if (tabName === 'borrow') {
                displayBorrowings();
                clearBorrowSelections();
            }
        }

        // Book mode switching
        function switchBookMode(mode) {
            document.querySelectorAll('.book-mode-switch .mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const singleSection = document.getElementById('singleBookSection');
            const bulkSection = document.getElementById('bulkBookSection');
            
            if (mode === 'single') {
                singleSection.style.display = 'block';
                bulkSection.classList.remove('active');
            } else {
                singleSection.style.display = 'none';
                bulkSection.classList.add('active');
            }
        }

        // Student mode switching
        function switchStudentMode(mode) {
            document.querySelectorAll('.student-mode-switch .mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const singleSection = document.getElementById('singleStudentSection');
            const bulkSection = document.getElementById('bulkStudentSection');
            
            if (mode === 'single') {
                singleSection.style.display = 'block';
                bulkSection.classList.remove('active');
            } else {
                singleSection.style.display = 'none';
                bulkSection.classList.add('active');
            }
        }

        // Category management
        function displayCategories() {
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = categories.map(category => `
                <div class="category-tag">
                    <span>${category}</span>
                    <button type="button" class="remove-btn" onclick="removeCategory('${category}')" title="Remove category">×</button>
                </div>
            `).join('');
        }

        function addCategory() {
            const input = document.getElementById('newCategoryInput');
            const newCategory = input.value.trim();
            
            if (!newCategory) {
                showNotification('Please enter a category name', 'error');
                return;
            }
            
            if (categories.includes(newCategory)) {
                showNotification('Category already exists', 'error');
                return;
            }
            
            categories.push(newCategory);
            saveData();
            input.value = '';
            displayCategories();
            updateCategoryDropdown();
            showNotification('Category added successfully!');
        }

        function removeCategory(categoryToRemove) {
            if (confirm(`Are you sure you want to remove the "${categoryToRemove}" category?`)) {
                categories = categories.filter(cat => cat !== categoryToRemove);
                saveData();
                displayCategories();
                updateCategoryDropdown();
                showNotification('Category removed successfully!');
            }
        }

        function updateCategoryDropdown() {
            const categorySelect = document.getElementById('bookCategory');
            categorySelect.innerHTML = '<option value="">Select Category</option>' +
                categories.map(category => `<option value="${category}">${category}</option>`).join('');
        }

        // Bulk functions
        function clearBulkBookData() {
            document.getElementById('bulkBookData').value = '';
        }

        function clearBulkStudentData() {
            document.getElementById('bulkStudentData').value = '';
        }

        // Book management
        document.getElementById('bookForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const book = {
                id: Date.now(),
                title: document.getElementById('bookTitle').value,
                author: document.getElementById('bookAuthor').value,
                isbn: document.getElementById('bookISBN').value,
                category: document.getElementById('bookCategory').value,
                available: true,
                borrowedBy: null,
                borrowedDate: null
            };
            
            books.push(book);
            saveData();
            this.reset();
            showNotification('Book added successfully!');
            displayBooks();
            updateDashboard();
        });

        document.getElementById('bulkBookForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const bulkData = document.getElementById('bulkBookData').value.trim();
            if (!bulkData) {
                showNotification('Please enter book data', 'error');
                return;
            }
            
            const lines = bulkData.split('\n').filter(line => line.trim());
            let successCount = 0;
            let errorCount = 0;
            
            lines.forEach((line, index) => {
                const parts = line.split('|').map(part => part.trim());
                
                if (parts.length !== 4) {
                    errorCount++;
                    return;
                }
                
                const [title, author, isbn, category] = parts;
                
                if (!title || !author || !isbn || !category) {
                    errorCount++;
                    return;
                }
                
                const book = {
                    id: Date.now() + index,
                    title: title,
                    author: author,
                    isbn: isbn,
                    category: category,
                    available: true,
                    borrowedBy: null,
                    borrowedDate: null
                };
                
                books.push(book);
                successCount++;
            });
            
            saveData();
            this.reset();
            
            if (successCount > 0) {
                showNotification(`${successCount} books added successfully!`);
                displayBooks();
                updateDashboard();
            }
            
            if (errorCount > 0) {
                showNotification(`${errorCount} books had errors and were skipped`, 'error');
            }
        });

        function displayBooks() {
            const bookList = document.getElementById('bookList');
            const searchTerm = document.getElementById('bookSearch').value.toLowerCase();
            
            const filteredBooks = books.filter(book => 
                book.title.toLowerCase().includes(searchTerm) ||
                book.author.toLowerCase().includes(searchTerm) ||
                book.isbn.includes(searchTerm)
            );
            
            bookList.innerHTML = filteredBooks.map(book => `
                <div class="card ${book.available ? '' : 'borrowed'}">
                    <h3>${book.title}</h3>
                    <p><strong>Author:</strong> ${book.author}</p>
                    <p><strong>ISBN:</strong> ${book.isbn}</p>
                    <p><strong>Category:</strong> ${book.category}</p>
                    <span class="status ${book.available ? 'available' : 'borrowed'}">
                        ${book.available ? 'Available' : 'Borrowed'}
                    </span>
                    ${!book.available ? `<p><strong>Borrowed by:</strong> ${getStudentName(book.borrowedBy)}</p>` : ''}
                    <br>
                    <button class="btn btn-danger" onclick="deleteBook(${book.id})">Delete</button>
                </div>
            `).join('');
        }

        function deleteBook(bookId) {
            if (confirm('Are you sure you want to delete this book?')) {
                books = books.filter(book => book.id !== bookId);
                saveData();
                showNotification('Book deleted successfully!');
                displayBooks();
                updateDashboard();
            }
        }

        // Student management
        document.getElementById('studentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const student = {
                id: Date.now(),
                name: document.getElementById('studentName').value,
                studentId: generateStudentId(),
                grade: document.getElementById('studentGrade').value,
                borrowedBooks: []
            };
            
            students.push(student);
            saveData();
            this.reset();
            showNotification('Student added successfully!');
            displayStudents();
            updateDashboard();
        });

        document.getElementById('bulkStudentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const bulkData = document.getElementById('bulkStudentData').value.trim();
            if (!bulkData) {
                showNotification('Please enter student data', 'error');
                return;
            }
            
            const lines = bulkData.split('\n').filter(line => line.trim());
            let successCount = 0;
            let errorCount = 0;
            
            lines.forEach((line, index) => {
                const parts = line.split('|').map(part => part.trim());
                
                if (parts.length !== 2) {
                    errorCount++;
                    return;
                }
                
                const [name, grade] = parts;
                
                if (!name || !grade) {
                    errorCount++;
                    return;
                }
                
                const student = {
                    id: Date.now() + index,
                    name: name,
                    studentId: generateStudentId(),
                    grade: grade,
                    borrowedBooks: []
                };
                
                students.push(student);
                successCount++;
            });
            
            saveData();
            this.reset();
            
            if (successCount > 0) {
                showNotification(`${successCount} students added successfully!`);
                displayStudents();
                updateDashboard();
            }
            
            if (errorCount > 0) {
                showNotification(`${errorCount} students had errors and were skipped`, 'error');
            }
        });

        function generateStudentId() {
            return 'STU' + Date.now().toString().slice(-6);
        }

        function displayStudents() {
            const studentList = document.getElementById('studentList');
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            
            const filteredStudents = students.filter(student => 
                student.name.toLowerCase().includes(searchTerm) ||
                student.studentId.includes(searchTerm)
            );
            
            studentList.innerHTML = filteredStudents.map(student => `
                <div class="card">
                    <h3>${student.name}</h3>
                    <p><strong>Student ID:</strong> ${student.studentId}</p>
                    <p><strong>Grade:</strong> ${student.grade}</p>
                    <p><strong>Books Borrowed:</strong> ${student.borrowedBooks.length}</p>
                    <button class="btn btn-danger" onclick="deleteStudent(${student.id})">Delete</button>
                </div>
            `).join('');
        }

        function deleteStudent(studentId) {
            if (confirm('Are you sure you want to delete this student?')) {
                students = students.filter(student => student.id !== studentId);
                saveData();
                showNotification('Student deleted successfully!');
                displayStudents();
                updateDashboard();
            }
        }

        // Borrow form search functionality
        document.getElementById('studentSearchBorrow').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const resultsDiv = document.getElementById('studentSearchResults');
            
            if (!searchTerm) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            const filteredStudents = students.filter(student => 
                student.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredStudents.length === 0) {
                resultsDiv.innerHTML = '<div class="search-result-item">No students found</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            resultsDiv.innerHTML = filteredStudents.map(student => `
                <div class="search-result-item" onclick="selectStudent(${student.id})">
                    <strong>${student.name}</strong><br>
                    <small>ID: ${student.studentId} | Grade: ${student.grade}</small>
                </div>
            `).join('');
            resultsDiv.style.display = 'block';
        });

        document.getElementById('bookSearchBorrow').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const resultsDiv = document.getElementById('bookSearchResults');
            
            if (!searchTerm) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            const availableBooks = books.filter(book => 
                book.available && 
                (book.title.toLowerCase().includes(searchTerm) || 
                 book.author.toLowerCase().includes(searchTerm))
            );
            
            if (availableBooks.length === 0) {
                resultsDiv.innerHTML = '<div class="search-result-item">No available books found</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            resultsDiv.innerHTML = availableBooks.map(book => `
                <div class="search-result-item" onclick="selectBook(${book.id})">
                    <strong>${book.title}</strong><br>
                    <small>by ${book.author} | ${book.category}</small>
                </div>
            `).join('');
            resultsDiv.style.display = 'block';
        });

        function selectStudent(studentId) {
            selectedStudentForBorrow = students.find(s => s.id === studentId);
            const selectedDiv = document.getElementById('selectedStudent');
            const searchInput = document.getElementById('studentSearchBorrow');
            const resultsDiv = document.getElementById('studentSearchResults');
            
            selectedDiv.innerHTML = `
                <strong>Selected Student:</strong> ${selectedStudentForBorrow.name}<br>
                <small>ID: ${selectedStudentForBorrow.studentId} | Grade: ${selectedStudentForBorrow.grade}</small>
                <button type="button" onclick="clearStudentSelection()" style="float: right; background: #fc8181; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">×</button>
            `;
            selectedDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            searchInput.value = '';
            
            updateBorrowButton();
        }

        function selectBook(bookId) {
            selectedBookForBorrow = books.find(b => b.id === bookId);
            const selectedDiv = document.getElementById('selectedBook');
            const searchInput = document.getElementById('bookSearchBorrow');
            const resultsDiv = document.getElementById('bookSearchResults');
            
            selectedDiv.innerHTML = `
                <strong>Selected Book:</strong> ${selectedBookForBorrow.title}<br>
                <small>by ${selectedBookForBorrow.author} | ${selectedBookForBorrow.category}</small>
                <button type="button" onclick="clearBookSelection()" style="float: right; background: #fc8181; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">×</button>
            `;
            selectedDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            searchInput.value = '';
            
            updateBorrowButton();
        }

        function clearStudentSelection() {
            selectedStudentForBorrow = null;
            document.getElementById('selectedStudent').style.display = 'none';
            updateBorrowButton();
        }

        function clearBookSelection() {
            selectedBookForBorrow = null;
            document.getElementById('selectedBook').style.display = 'none';
            updateBorrowButton();
        }

        function clearBorrowSelections() {
            selectedStudentForBorrow = null;
            selectedBookForBorrow = null;
            document.getElementById('selectedStudent').style.display = 'none';
            document.getElementById('selectedBook').style.display = 'none';
            document.getElementById('studentSearchBorrow').value = '';
            document.getElementById('bookSearchBorrow').value = '';
            document.getElementById('studentSearchResults').style.display = 'none';
            document.getElementById('bookSearchResults').style.display = 'none';
            updateBorrowButton();
        }

        function updateBorrowButton() {
            const borrowBtn = document.getElementById('borrowBtn');
            borrowBtn.disabled = !selectedStudentForBorrow || !selectedBookForBorrow;
        }

        function borrowBook() {
            if (!selectedStudentForBorrow || !selectedBookForBorrow) {
                showNotification('Please select both a student and a book', 'error');
                return;
            }
            
            const borrowing = {
                id: Date.now(),
                studentId: selectedStudentForBorrow.id,
                bookId: selectedBookForBorrow.id,
                borrowDate: new Date().toISOString().split('T')[0],
                returnDate: null
            };
            
            borrowings.push(borrowing);
            selectedBookForBorrow.available = false;
            selectedBookForBorrow.borrowedBy = selectedStudentForBorrow.id;
            selectedBookForBorrow.borrowedDate = borrowing.borrowDate;
            selectedStudentForBorrow.borrowedBooks.push(selectedBookForBorrow.id);
            
            saveData();
            showNotification(`Book "${selectedBookForBorrow.title}" borrowed by ${selectedStudentForBorrow.name}!`);
            clearBorrowSelections();
            displayBorrowings();
            updateDashboard();
        }

        // Search for books to return
        function searchBooksToReturn() {
            const searchTerm = document.getElementById('returnBookSearch').value.toLowerCase();
            const resultsDiv = document.getElementById('returnSearchResults');
            
            if (!searchTerm.trim()) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            const activeBorrowings = borrowings.filter(b => !b.returnDate);
            const filteredBorrowings = activeBorrowings.filter(borrowing => {
                const book = books.find(b => b.id === borrowing.bookId);
                const student = students.find(s => s.id === borrowing.studentId);
                
                return book.title.toLowerCase().includes(searchTerm) ||
                       book.author.toLowerCase().includes(searchTerm) ||
                       student.name.toLowerCase().includes(searchTerm) ||
                       student.studentId.toLowerCase().includes(searchTerm);
            });
            
            if (filteredBorrowings.length === 0) {
                resultsDiv.innerHTML = '<p style="text-align: center; color: #718096;">No borrowed books found matching your search.</p>';
                return;
            }
            
            resultsDiv.innerHTML = filteredBorrowings.map(borrowing => {
                const book = books.find(b => b.id === borrowing.bookId);
                const student = students.find(s => s.id === borrowing.studentId);
                return `
                    <div class="card">
                        <h3>${book.title}</h3>
                        <p><strong>Author:</strong> ${book.author}</p>
                        <p><strong>Borrowed by:</strong> ${student.name} (${student.studentId})</p>
                        <p><strong>Borrow Date:</strong> ${borrowing.borrowDate}</p>
                        <button class="btn" onclick="returnBookDirectly(${borrowing.id})">Return This Book</button>
                    </div>
                `;
            }).join('');
        }

        function returnBookDirectly(borrowingId) {
            const borrowing = borrowings.find(b => b.id === borrowingId);
            const book = books.find(b => b.id === borrowing.bookId);
            const student = students.find(s => s.id === borrowing.studentId);
            
            borrowing.returnDate = new Date().toISOString().split('T')[0];
            book.available = true;
            book.borrowedBy = null;
            book.borrowedDate = null;
            student.borrowedBooks = student.borrowedBooks.filter(id => id !== borrowing.bookId);
            
            saveData();
            showNotification(`Book "${book.title}" returned by ${student.name}!`);
            displayBorrowings();
            updateDashboard();
            
            // Clear search results
            document.getElementById('returnBookSearch').value = '';
            document.getElementById('returnSearchResults').innerHTML = '';
        }

        function displayBorrowings() {
            const borrowingList = document.getElementById('borrowingList');
            const activeBorrowings = borrowings.filter(b => !b.returnDate);
            
            borrowingList.innerHTML = activeBorrowings.map(borrowing => {
                const book = books.find(b => b.id === borrowing.bookId);
                const student = students.find(s => s.id === borrowing.studentId);
                return `
                    <div class="card">
                        <h3>${book.title}</h3>
                        <p><strong>Borrowed by:</strong> ${student.name} (${student.studentId})</p>
                        <p><strong>Author:</strong> ${book.author}</p>
                        <p><strong>Borrow Date:</strong> ${borrowing.borrowDate}</p>
                        <button class="btn" onclick="returnBookDirectly(${borrowing.id})">Return Book</button>
                    </div>
                `;
            }).join('');
        }

        function getStudentName(studentId) {
            const student = students.find(s => s.id === studentId);
            return student ? student.name : 'Unknown';
        }

        function updateDashboard() {
            document.getElementById('totalBooks').textContent = books.length;
            document.getElementById('availableBooks').textContent = books.filter(b => b.available).length;
            document.getElementById('borrowedBooks').textContent = books.filter(b => !b.available).length;
            document.getElementById('totalStudents').textContent = students.length;
            
            // Update recent activity
            const recentActivity = document.getElementById('recentActivity');
            const recentBorrowings = borrowings.slice(-3).reverse();
            
            if (recentBorrowings.length > 0) {
                recentActivity.innerHTML = recentBorrowings.map(borrowing => {
                    const book = books.find(b => b.id === borrowing.bookId);
                    const student = students.find(s => s.id === borrowing.studentId);
                    return `
                        <div class="card">
                            <h3>${borrowing.returnDate ? '📚 Book Returned' : '📖 Book Borrowed'}</h3>
                            <p><strong>Book:</strong> ${book.title}</p>
                            <p><strong>Student:</strong> ${student.name}</p>
                            <p><strong>Date:</strong> ${borrowing.returnDate || borrowing.borrowDate}</p>
                        </div>
                    `;
                }).join('');
            }
        }

        // Search functionality
        document.getElementById('bookSearch').addEventListener('input', displayBooks);
        document.getElementById('studentSearch').addEventListener('input', displayStudents);
        document.getElementById('returnBookSearch').addEventListener('input', searchBooksToReturn);

        // Enter key support for adding categories
        document.getElementById('newCategoryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addCategory();
            }
        });

        // Initialize the app
        displayBooks();
        displayStudents();
        displayCategories();
        updateCategoryDropdown();
        displayBorrowings();
        updateDashboard();